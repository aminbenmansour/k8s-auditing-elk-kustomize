nameOverride: "filebeat-audit"
filebeatConfig:
  filebeat.yml: |
    filebeat.inputs:
    # Collect Kubernetes audit logs
    - type: log
      paths:
        - /var/log/kubernetes/audit/*.log

      # Keep JSON structured (don't flatten)
      json.keys_under_root: false
      json.add_error_key: true

      # Add fields at root level
      fields_under_root: true
      fields:
        logtype: audit
        component: kube-apiserver
        data_stream:
          type: logs
          dataset: kubernetes.audit_logs
          namespace: default

      processors:
      # Move the entire JSON object under kubernetes.audit
      - script:
          lang: javascript
          source: >
            function process(event) {
              // Get the parsed JSON
              var auditData = event.Get("json");
              if (auditData) {
                // Set kubernetes.audit with the audit data
                event.Put("kubernetes.audit", auditData);
                // Remove the original json field
                event.Delete("json");
              }
            }
    # Output to Logstash
    output.logstash:
      hosts: ["logstash-logstash:5044"]

    # Logging configuration
    logging.level: info
    logging.to_files: true
    logging.files:
      path: /var/log/filebeat
      name: filebeat
      keepfiles: 7
      permissions: 0644

# Mount audit log path
extraVolumes:
  - name: audit-log
    hostPath:
      path: /var/log/kubernetes/audit/
      type: Directory

extraVolumeMounts:
  - name: audit-log
    mountPath: /var/log/kubernetes/audit/
    readOnly: true

# Only run on control plane nodes
nodeSelector:
  node-role.kubernetes.io/control-plane: ""

# Ensure Filebeat runs on master nodes to access audit logs
tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule
